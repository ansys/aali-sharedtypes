
name: Auto-generate gRPC files
on:
  push:
    branches:
      - main

jobs:

    protoc:
        name: Create gRPC autogenerated files and commit
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup Go
          uses: actions/setup-go@v5
          with:
            go-version-file: 'go.mod'
            cache-dependency-path: 'go.sum'

        - name: Install Protoc
          run: |
            sudo apt-get update
            sudo apt-get install -y protobuf-compiler

        - name: Navigate to root folder and run Protoc
          run: |
            cd $GITHUB_WORKSPACE
            protoc --go_out=pkg --go-grpc_out=pkg pkg/protos/allie-flowkit.proto

        - name: Commit and push
          run: |
            cd $GITHUB_WORKSPACE
            git config --global user.email '${{ github.actor }}@users.noreply.github.com'
            git config --global user.name '${{ github.actor }}'
            git add -f pkg/allieflowkitgrpc/
            git commit -a -m 'Auto-generate gRPC files' || echo "No changes to commit"
            git push origin main
